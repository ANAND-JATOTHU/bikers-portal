<%- include('partials/header') %>

<div class="container py-4 bike-detail-page">
  <div class="row">
    <!-- Breadcrumbs -->
    <div class="col-12 mb-4">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb bg-light p-2">
          <li class="breadcrumb-item"><a href="/">Home</a></li>
          <li class="breadcrumb-item"><a href="/bikes">Motorcycles</a></li>
          <li class="breadcrumb-item active" aria-current="page"><%= bike.title %></li>
        </ol>
      </nav>
    </div>

    <!-- Image Gallery Section -->
    <div class="col-md-8 mb-4">
      <div class="bike-gallery">
        <% if (bike.images && bike.images.length > 0) { %>
          <!-- Main Image -->
          <div class="main-image-container mb-2">
            <img src="<%= bike.images[0] %>" alt="<%= bike.title %>" class="img-fluid main-image" id="mainImage">
          </div>
          
          <!-- Thumbnails -->
          <div class="thumbnails d-flex flex-wrap">
            <% bike.images.forEach((image, index) => { %>
              <div class="thumbnail-container me-2 mb-2" onclick="changeMainImage('<%= image %>', this)">
                <img src="<%= image %>" alt="<%= bike.title %> <%= index + 1 %>" class="img-thumbnail <%= index === 0 ? 'active' : '' %>">
              </div>
            <% }); %>
          </div>
        <% } else { %>
          <div class="no-image-container">
            <img src="/images/no-image.jpg" alt="No image available" class="img-fluid">
          </div>
        <% } %>
      </div>
    </div>

    <!-- Bike Info Section -->
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h1 class="h2 card-title mb-3"><%= bike.title %></h1>
          <div class="pricing mb-3">
            <span class="price display-5 fw-bold text-primary">₹<%= bike.price.toLocaleString() %></span>
          </div>
          
          <% if (bike.availability) { %>
            <span class="badge bg-success mb-3">Available</span>
          <% } else { %>
            <span class="badge bg-danger mb-3">Sold</span>
          <% } %>
          
          <div class="location mb-3">
            <i class="fas fa-map-marker-alt text-secondary"></i>
            <span><%= bike.location %></span>
          </div>
          
          <% if (user && bike.seller._id.toString() !== user._id.toString()) { %>
            <div class="d-grid gap-2 mb-3">
              <button class="btn btn-primary contact-seller-btn" data-bs-toggle="modal" data-bs-target="#contactSellerModal">
                <i class="fas fa-comment-alt me-2"></i>Contact Seller
              </button>
              <a href="tel:<%= bike.seller.phone %>" class="btn btn-outline-primary">
                <i class="fas fa-phone me-2"></i>Call Seller
              </a>
            </div>
          <% } else if (user && bike.seller._id.toString() === user._id.toString()) { %>
            <div class="d-grid gap-2 mb-3">
              <a href="/bikes/<%= bike._id %>/edit" class="btn btn-warning">
                <i class="fas fa-edit me-2"></i>Edit Listing
              </a>
              <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteListingModal">
                <i class="fas fa-trash me-2"></i>Delete Listing
              </button>
              <% if (bike.availability) { %>
                <button class="btn btn-outline-dark" onclick="markUnavailable('<%= bike._id %>')">
                  <i class="fas fa-check-circle me-2"></i>Mark as Sold
                </button>
              <% } else { %>
                <button class="btn btn-outline-success" onclick="markAvailable('<%= bike._id %>')">
                  <i class="fas fa-redo me-2"></i>Relist
                </button>
              <% } %>
            </div>
          <% } else { %>
            <div class="alert alert-info">
              <a href="/login" class="alert-link">Login</a> to contact the seller
            </div>
          <% } %>
          
          <div class="seller-info mt-4">
            <h5>About the Seller</h5>
            <div class="d-flex align-items-center mb-2">
              <% if (bike.seller.profileImage) { %>
                <img src="<%= bike.seller.profileImage %>" alt="<%= bike.seller.username %>" class="rounded-circle me-2" width="40">
              <% } else { %>
                <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px; color: white;">
                  <i class="fas fa-user"></i>
                </div>
              <% } %>
              <div>
                <a href="/sellers/<%= bike.seller._id %>" class="fw-bold text-decoration-none">
                  <%= bike.seller.username %>
                </a>
                <div class="text-muted small">Member since <%= new Date(bike.seller.joinedAt).toLocaleDateString() %></div>
              </div>
            </div>
            <div class="mt-2">
              <a href="/sellers/<%= bike.seller._id %>" class="btn btn-sm btn-outline-secondary">
                View Profile
              </a>
              <a href="/sellers/<%= bike.seller._id %>/bikes" class="btn btn-sm btn-outline-secondary">
                View All Listings
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Bike Details Section -->
  <div class="row mt-4">
    <div class="col-lg-8">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
          <ul class="nav nav-tabs card-header-tabs" id="bikeDetailsTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="true">
                Overview
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="specifications-tab" data-bs-toggle="tab" data-bs-target="#specifications" type="button" role="tab" aria-controls="specifications" aria-selected="false">
                Specifications
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="features-tab" data-bs-toggle="tab" data-bs-target="#features" type="button" role="tab" aria-controls="features" aria-selected="false">
                Features
              </button>
            </li>
          </ul>
        </div>
        <div class="card-body">
          <div class="tab-content" id="bikeDetailsTabsContent">
            <!-- Overview Tab -->
            <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
              <h4 class="mb-3">Description</h4>
              <p class="bike-description"><%= bike.description %></p>
              
              <div class="row mt-4">
                <div class="col-md-6">
                  <div class="mb-3">
                    <span class="text-muted">Brand:</span>
                    <span class="fw-bold ms-2"><%= bike.brand %></span>
                  </div>
                  <div class="mb-3">
                    <span class="text-muted">Model:</span>
                    <span class="fw-bold ms-2"><%= bike.model %></span>
                  </div>
                  <div class="mb-3">
                    <span class="text-muted">Year:</span>
                    <span class="fw-bold ms-2"><%= bike.year %></span>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <span class="text-muted">Condition:</span>
                    <span class="fw-bold ms-2"><%= bike.condition %></span>
                  </div>
                  <div class="mb-3">
                    <span class="text-muted">Category:</span>
                    <span class="fw-bold ms-2"><%= bike.category %></span>
                  </div>
                  <div class="mb-3">
                    <span class="text-muted">Color:</span>
                    <span class="fw-bold ms-2"><%= bike.color %></span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Specifications Tab -->
            <div class="tab-pane fade" id="specifications" role="tabpanel" aria-labelledby="specifications-tab">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <span class="text-muted">Engine Capacity:</span>
                    <span class="fw-bold ms-2"><%= bike.engineCapacity %> cc</span>
                  </div>
                  <div class="mb-3">
                    <span class="text-muted">Mileage:</span>
                    <span class="fw-bold ms-2"><%= bike.mileage %> km</span>
                  </div>
                  <div class="mb-3">
                    <span class="text-muted">Fuel Type:</span>
                    <span class="fw-bold ms-2"><%= bike.fuelType %></span>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <span class="text-muted">Listed On:</span>
                    <span class="fw-bold ms-2"><%= new Date(bike.createdAt).toLocaleDateString() %></span>
                  </div>
                  <% if (bike.updatedAt && bike.updatedAt > bike.createdAt) { %>
                    <div class="mb-3">
                      <span class="text-muted">Last Updated:</span>
                      <span class="fw-bold ms-2"><%= new Date(bike.updatedAt).toLocaleDateString() %></span>
                    </div>
                  <% } %>
                </div>
              </div>
            </div>
            
            <!-- Features Tab -->
            <div class="tab-pane fade" id="features" role="tabpanel" aria-labelledby="features-tab">
              <% if (bike.features && bike.features.length > 0) { %>
                <div class="row">
                  <div class="col-md-12">
                    <ul class="list-group list-group-flush">
                      <% bike.features.forEach(feature => { %>
                        <li class="list-group-item">
                          <i class="fas fa-check-circle text-success me-2"></i>
                          <%= feature %>
                        </li>
                      <% }); %>
                    </ul>
                  </div>
                </div>
              <% } else { %>
                <div class="alert alert-info">
                  No specific features listed for this motorcycle.
                </div>
              <% } %>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Similar Bikes Section -->
      <% if (similarBikes && similarBikes.length > 0) { %>
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-white">
            <h4 class="mb-0">Similar Motorcycles</h4>
          </div>
          <div class="card-body">
            <div class="row">
              <% similarBikes.forEach(similarBike => { %>
                <div class="col-md-6 col-xl-3 mb-3">
                  <div class="card h-100 bike-card">
                    <div class="card-img-top-container">
                      <% if (similarBike.images && similarBike.images.length > 0) { %>
                        <img src="<%= similarBike.images[0] %>" class="card-img-top" alt="<%= similarBike.title %>">
                      <% } else { %>
                        <img src="/images/no-image.jpg" class="card-img-top" alt="No image available">
                      <% } %>
                      <div class="bike-price">₹<%= similarBike.price.toLocaleString() %></div>
                    </div>
                    <div class="card-body">
                      <h5 class="card-title text-truncate"><%= similarBike.title %></h5>
                      <div class="d-flex justify-content-between bike-quick-info">
                        <span><i class="fas fa-calendar-alt"></i> <%= similarBike.year %></span>
                        <span><i class="fas fa-tachometer-alt"></i> <%= similarBike.engineCapacity %> cc</span>
                      </div>
                      <a href="/bikes/<%= similarBike._id %>" class="stretched-link"></a>
                    </div>
                  </div>
                </div>
              <% }); %>
            </div>
          </div>
        </div>
      <% } %>
      
      <!-- Seller's Other Bikes Section -->
      <% if (sellerOtherBikes && sellerOtherBikes.length > 0) { %>
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-white">
            <h4 class="mb-0">More from this Seller</h4>
          </div>
          <div class="card-body">
            <div class="row">
              <% sellerOtherBikes.forEach(otherBike => { %>
                <div class="col-md-6 col-xl-3 mb-3">
                  <div class="card h-100 bike-card">
                    <div class="card-img-top-container">
                      <% if (otherBike.images && otherBike.images.length > 0) { %>
                        <img src="<%= otherBike.images[0] %>" class="card-img-top" alt="<%= otherBike.title %>">
                      <% } else { %>
                        <img src="/images/no-image.jpg" class="card-img-top" alt="No image available">
                      <% } %>
                      <div class="bike-price">₹<%= otherBike.price.toLocaleString() %></div>
                    </div>
                    <div class="card-body">
                      <h5 class="card-title text-truncate"><%= otherBike.title %></h5>
                      <div class="d-flex justify-content-between bike-quick-info">
                        <span><i class="fas fa-calendar-alt"></i> <%= otherBike.year %></span>
                        <span><i class="fas fa-tachometer-alt"></i> <%= otherBike.engineCapacity %> cc</span>
                      </div>
                      <a href="/bikes/<%= otherBike._id %>" class="stretched-link"></a>
                    </div>
                  </div>
                </div>
              <% }); %>
            </div>
          </div>
        </div>
      <% } %>
    </div>
    
    <!-- Safety Tips & Advertising Section -->
    <div class="col-lg-4">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-warning text-dark">
          <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Safety Tips</h5>
        </div>
        <div class="card-body">
          <ul class="list-unstyled safety-tips">
            <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Meet in a safe, public place</li>
            <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Check the motorcycle's documentation</li>
            <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Inspect the motorcycle thoroughly</li>
            <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Test ride only after checking documentation</li>
            <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Verify the seller's identity</li>
            <li><i class="fas fa-check-circle text-success me-2"></i>Use secure payment methods</li>
          </ul>
          <a href="/safety-guidelines" class="btn btn-outline-warning mt-2 w-100">Read Full Safety Guidelines</a>
        </div>
      </div>
      
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h5 class="card-title">Looking for financing?</h5>
          <p class="card-text">Get instant approval for your dream motorcycle with our financing partners.</p>
          <a href="/bike-finance" class="btn btn-primary w-100">Apply for Financing</a>
        </div>
      </div>
      
      <div class="card shadow-sm mb-4">
        <div class="card-body text-center">
          <h5 class="card-title">Need Insurance?</h5>
          <p class="card-text">Compare insurance quotes from top providers</p>
          <a href="/bike-insurance" class="btn btn-outline-primary w-100">Get Insurance Quotes</a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Contact Seller Modal -->
<div class="modal fade" id="contactSellerModal" tabindex="-1" aria-labelledby="contactSellerModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="contactSellerModalLabel">Contact the Seller</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="contactSellerForm">
          <input type="hidden" name="bikeId" value="<%= bike._id %>">
          <input type="hidden" name="sellerId" value="<%= bike.seller._id %>">
          
          <div class="mb-3">
            <label for="messageSubject" class="form-label">Subject</label>
            <input type="text" class="form-control" id="messageSubject" name="subject" value="Regarding your <%= bike.brand %> <%= bike.model %>" required>
          </div>
          
          <div class="mb-3">
            <label for="messageBody" class="form-label">Message</label>
            <textarea class="form-control" id="messageBody" name="message" rows="5" required>Hi, I am interested in your <%= bike.title %> priced at ₹<%= bike.price.toLocaleString() %>. Is this still available?</textarea>
          </div>
          
          <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="includePhone" name="includePhone" checked>
            <label class="form-check-label" for="includePhone">Include my phone number in the message</label>
          </div>
          
          <button type="submit" class="btn btn-primary w-100">Send Message</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Delete Listing Modal -->
<% if (user && bike.seller._id.toString() === user._id.toString()) { %>
  <div class="modal fade" id="deleteListingModal" tabindex="-1" aria-labelledby="deleteListingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteListingModalLabel">Confirm Deletion</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete this listing? This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" onclick="deleteBike('<%= bike._id %>')">Delete</button>
        </div>
      </div>
    </div>
  </div>
<% } %>

<script>
  function changeMainImage(imageSrc, element) {
    // Update main image
    document.getElementById('mainImage').src = imageSrc;
    
    // Update active thumbnail
    const thumbnails = document.querySelectorAll('.thumbnails img');
    thumbnails.forEach(thumb => thumb.classList.remove('active'));
    element.querySelector('img').classList.add('active');
  }
  
  function markUnavailable(bikeId) {
    if (confirm('Mark this motorcycle as sold?')) {
      fetch(`/bikes/${bikeId}/availability`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ availability: false }),
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          window.location.reload();
        } else {
          alert(data.message || 'Failed to update status');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
      });
    }
  }
  
  function markAvailable(bikeId) {
    if (confirm('Relist this motorcycle as available?')) {
      fetch(`/bikes/${bikeId}/availability`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ availability: true }),
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          window.location.reload();
        } else {
          alert(data.message || 'Failed to update status');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
      });
    }
  }
  
  function deleteBike(bikeId) {
    fetch(`/bikes/${bikeId}`, {
      method: 'DELETE',
    })
    .then(response => {
      if (response.redirected) {
        window.location.href = response.url;
      } else {
        return response.json();
      }
    })
    .then(data => {
      if (data && !data.success) {
        alert(data.message || 'Failed to delete listing');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred. Please try again.');
    });
  }
  
  // Contact seller form submission
  document.getElementById('contactSellerForm')?.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const formObject = {};
    formData.forEach((value, key) => {
      formObject[key] = value;
    });
    
    fetch('/messages/send', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(formObject),
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Message sent successfully!');
        $('#contactSellerModal').modal('hide');
      } else {
        alert(data.message || 'Failed to send message');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred. Please try again.');
    });
  });
</script>

<%- include('partials/footer') %> 